{{/* Hugo Blox: Contact */}}
{{/* Documentation: https://hugoblox.com/blocks/ */}}
{{/* License: https://github.com/HugoBlox/hugo-blox-builder/blob/main/LICENSE.md */}}

{{/* Initialise */}}
{{ $page := .wcPage }}
{{ $block := .wcBlock }}
{{ $autolink := default true $block.content.autolink }}
{{ $data := $block.content }}

{{ $form_provider := lower $block.content.form.provider | default "" }}

{{ $use_netlify_form := eq $form_provider "netlify" }}
{{ $use_formspree_form := eq $form_provider "formspree" }}
{{ $use_form := or $use_netlify_form $use_formspree_form }}

{{ $use_netlify_captcha := $block.content.form.netlify.captcha | default true }}
{{ $use_formspree_captcha := $block.content.form.formspree.captcha | default false }}

{{ $columns := $block.design.columns | default "2" }}

{{ if and $use_formspree_form $use_formspree_captcha }}
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
{{ end }}

<div class="col-12 {{if eq $columns "2"}}col-lg-8{{end}}">
  {{ with $block.content.text }}<p>{{ . | emojify | $page.RenderString }}</p>{{ end }}

  {{ if $use_form }}

    {{ $post_action := "" }}
    {{ if $use_netlify_form }}
      {{ $post_action = "netlify" }}
    {{ else if $use_formspree_form }}
      {{ if not $block.content.form.formspree.id }}
        {{ errorf "You have chosen to use Formspree as the provider for the contact form. Please set your Formspree Form ID in the Contact widget or disable the form.\nDocumentation: https://docs.hugoblox.com/widget/contact/" }}
      {{ end }}
      {{ if and $use_formspree_captcha (not $block.content.form.formspree.captcha_key) }}
        {{ errorf "You have chosen to use reCAPTCHA for Formspree. Please set your Formspree CAPTCHA KEY in the Contact widget or disable reCAPTCHA.\nDocumentation: https://help.formspree.io/hc/en-us/articles/360022811154" }}
      {{ end }}
      {{ $post_action = printf "action=\"https://formspree.io/f/%s\"" $block.content.form.formspree.id }}
    {{ end }}

    <div class="mb-3">
      <form name="contact" method="POST" {{ $post_action | safeHTMLAttr }} {{ if $use_netlify_form }}netlify-honeypot="_gotcha"{{ end }} {{ if $use_netlify_captcha }}data-netlify-recaptcha="true"{{ end }} {{ with $block.content.form.netlify.success_url }}action="{{ . | relLangURL }}"{{ end }}>
        <div class="form-group form-inline">
          <label class="sr-only" for="inputName">{{ i18n "contact_name" }}</label>
          <input type="text" name="name" class="form-control w-100" id="inputName" placeholder="{{ i18n "contact_name" | default "Name" }}" required>
        </div>
        <div class="form-group form-inline">
          <label class="sr-only" for="inputEmail">{{ i18n "contact_email" }}</label>
          <input type="email" name="email" class="form-control w-100" id="inputEmail" placeholder="{{ i18n "contact_email" | default "Email" }}" required>
        </div>
        <div class="form-group">
          <label class="sr-only" for="inputMessage">{{ i18n "contact_message" }}</label>
          <textarea name="message" class="form-control" id="inputMessage" rows="5" placeholder="{{ i18n "contact_message" | default "Message" }}" required></textarea>
        </div>
        {{ if $block.content.form.netlify.attachments }}
          <div class="form-group form-inline">
            <label class="sr-only" for="fileUpload">{{ i18n "contact_attachment" }}</label>
            <input type="file" name="file" class="form-control w-100" id="fileUpload" placeholder="{{ i18n "contact_attachment" | default "Attach file" }}">
          </div>
        {{ end }}
        <div class="d-none">
          <label>Do not fill this field unless you are a bot: <input name="_gotcha"></label>
        </div>
        {{ if and $use_netlify_form $use_netlify_captcha }}
          <div class="form-group" data-netlify-recaptcha="true"></div>
        {{ else if and $use_formspree_form $use_formspree_captcha }}
          <div class="g-recaptcha" data-sitekey="{{ $block.content.form.formspree.captcha_key }}"></div>
          </br>
        {{ end }}
        <button type="submit" class="btn btn-primary px-3 py-2 w-100">{{ i18n "contact_send" | default "Send" }}</button>
      </form>
    </div>
  {{ end }}

{{ range $data.locations }}
  <div class="offices">
      <div class="office">
        <h3>{{ .name }}</h3>
        {{ .address.street }}, {{ .address.city }}, {{ .address.country }}, {{ .phone }}, <a href="mailto:{{ .email }}">{{ .email }}</a>, {{ range .office_hours }}{{ . }}<br>{{ end }}
      </div>
  </div>
    {{ end }}

{{ $locations := $data.locations }}
{{ if and site.Params.features.map.provider (gt (len $locations) 0) }}

  <!-- Map Container -->
  <div id="map"></div>

  <script>
document.addEventListener("DOMContentLoaded", function() {
  const map = L.map('map');

  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors',
    maxZoom: 15
  }).addTo(map);

  const bounds = [];
  {{ range $index, $loc := $locations }}
    if (!isNaN({{ .coordinates.latitude }}) && !isNaN({{ .coordinates.longitude }})) {
	L.marker(["{{ .coordinates.latitude }}", "{{ .coordinates.longitude }}"]).addTo(map)
        .bindPopup("<b>{{ .name }}</b><br>{{ .address.street }}, {{ .address.city }}");
      bounds.push(["{{ .coordinates.latitude }}", "{{ .coordinates.longitude }}"]);
    }
  {{ end }}

  if (bounds.length > 0) {
    map.fitBounds(bounds);
  } else {
    map.setView([40,50],2);
  }
});
</script>

</div>

{{ end }}





</div>
